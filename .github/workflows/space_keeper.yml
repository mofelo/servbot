name: 🛡️ Gradio Space 每6小时保活+ webhook

on:
  schedule:
    # 每6小时运行一次 (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # 允许手动触发
    inputs:
      mode:
        description: '运行模式'
        required: true
        default: 'ping'
        type: choice
        options:
        - ping
        - restart
  # 新增：通过 repository_dispatch 接收 Webhook
  repository_dispatch:
    types: [space-updated, space-restarted]
jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # 根据触发方式设置模式
    steps:
    - name: 🎯 确定运行模式
      id: mode
      run: |
        if [[ "${{ github.event_name }}" == "schedule" ]]; then
          echo "mode=ping" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
          if [[ "${{ github.event.action }}" == "space-updated" ]]; then
            echo "mode=ping" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.action }}" == "space-restarted" ]]; then
            echo "mode=restart" >> $GITHUB_OUTPUT
          fi
        fi
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 🐍 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 🔧 安装 Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
        
    - name: 📦 安装 Python 依赖
      run: |
        pip install selenium webdriver-manager
        
    - name: 🎯 保活 Space
      env:
        HF_SPACE_URL: ${{ secrets.HF_SPACE_URL }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        MODE="${{ steps.mode.outputs.mode }}"
        echo "🔧 运行模式: $MODE (触发: ${{ github.event_name }})"
        
        python space_keeper.py --mode "$MODE"
