name: ğŸ›¡ï¸ Gradio Space æ¯6å°æ—¶ä¿æ´»+ webhook

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'ping'
        type: choice
        options:
        - ping
        - restart
  # æ–°å¢ï¼šé€šè¿‡ repository_dispatch æ¥æ”¶ Webhook
  repository_dispatch:
    types: [space-updated, space-restarted]
jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # æ ¹æ®è§¦å‘æ–¹å¼è®¾ç½®æ¨¡å¼
    steps:
    - name: ğŸ¯ ç¡®å®šè¿è¡Œæ¨¡å¼
      id: mode
      run: |
        if [[ "${{ github.event_name }}" == "schedule" ]]; then
          echo "mode=ping" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
          if [[ "${{ github.event.action }}" == "space-updated" ]]; then
            echo "mode=ping" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.action }}" == "space-restarted" ]]; then
            echo "mode=restart" >> $GITHUB_OUTPUT
          fi
        fi
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ”§ å®‰è£… Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
        
    - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
      run: |
        pip install selenium webdriver-manager
        
    - name: ğŸ¯ ä¿æ´» Space
      env:
        HF_SPACE_URL: ${{ secrets.HF_SPACE_URL }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        MODE="${{ steps.mode.outputs.mode }}"
        echo "ğŸ”§ è¿è¡Œæ¨¡å¼: $MODE (è§¦å‘: ${{ github.event_name }})"
        
        python space_keeper.py --mode "$MODE"
